<script type="text/javascript" src="/media/js/ZeroClipboard.js"></script>
<script type="text/javascript">
    ZeroClipboard.setMoviePath('/media/js/ZeroClipboard.swf');
</script>
<script type="text/javascript">
var customize_types = {
    "none": [], 
    "lens": [
    {
        "name": "lensType", 
        "label": "Lens Type", 
        "type": "select", 
        "options": [
            {"label": "Single Vision Lenses All Time Wear(Free)", "value":"1"}, 
            {"label": "Single Vision Lenses Reading Only(Free)", "value":"2"}, 
            {"label": "Progressive Lenses No Line", "value":"3"}, 
            {"label": "Bifocal Lenses With A Line", "value":"4"}, 
            {"label": "Single Vison Lenses Computer Glasses(Free)", "value":"5"}, 
            {"label": "Fashion Glasses with No Prescription(Free)", "value":"6"}, 
        ]
    }, 
        {"name": "lens_price", "label": "Lens Price", "type":"text"}, 
        {"name": "od_sph", "label": "SPH OD", "type":"text"}, 
        {"name": "os_sph", "label": "SPH OS", "type":"text"}, 
        {"name": "od_cyl", "label": "CYL OD", "type":"text"}, 
        {"name": "os_cyl", "label": "CYL OS", "type":"text"}, 
        {"name": "od_axis", "label": "Axis OD", "type":"text"}, 
        {"name": "os_axis", "label": "Axis OS", "type":"text"}, 
        {"name": "od_add", "label": "Add OD", "type":"text"}, 
        {"name": "os_add", "label": "Add OS", "type":"text"}, 
        {"name": "lens_pd", "label": "PD", "type":"text"}, 
        {"name": "pd_far", "label": "PD Far", "type":"text"}, 
        {"name": "pd_near", "label": "PD Near", "type":"text"}, 
        {"name": "pd_l", "label": "Left PD", "type":"text"}, 
        {"name": "pd_r", "label": "Right PD", "type":"text"}, 
        {
            "name": "lens_index", 
            "label": "Lens Index", 
            "type": "select", 
            "options": [
                {"label": "Plastic Lenses (Index 1.499)", "value": "1"}, 
                {"label": "Thinner Lenses (Middle Index 1.553)", "value": "2"}, 
                {"label": "Super Thin Lenses (High Index 1.600)", "value": "3"}, 
                {"label": "Diamond Clear Polycarbonate (High Index 1.591)", "value": "4"}, 
                {"label": "Ultra Thin Lenses (High Index 1.670) ", "value": "5"}, 
                {"label": "Extreme Thin Lenses (High Index 1.740)", "value": "6"}, 
                {"label": "Polarized Lenses (Index 1.499)", "value": "7"}, 
            ]
        }, 
        {
            "name": "lens_index_color", 
            "label": "Lens Index Color", 
            "type": "select", 
            "options": [
                {"label": "No Lens Index Color", "value": ""}, 
                {"label": "G-15", "value": "G-15"}, 
                {"label": "Brown", "value": "Brown"}, 
                {"label": "Grey", "value": "Grey"}, 
            ]
        }, 
        {
            "name": "chb_color_tint", 
            "label": "Tint", 
            "type": "select", 
            "options": [
                {"label": "No", "value": ""}, 
                {"label": "Yes", "value": "1"}, 
            ]
        }, 
        {
            "name": "color_tint", 
            "label": "Tint Color", 
            "type": "select", 
            "options": [
                {"label": "No Tint", "value": ""}, 
                {"label": "Green 20%", "value": "Green 20%"}, 
                {"label": "Green 40%", "value": "Green 40%"}, 
                {"label": "Green 60%", "value": "Green 60%"}, 
                {"label": "Green 80%", "value": "Green 80%"}, 
                {"label": "Brown 20%", "value": "Brown 20%"}, 
                {"label": "Brown 40%", "value": "Brown 40%"}, 
                {"label": "Brown 60%", "value": "Brown 60%"}, 
                {"label": "Brown 80%", "value": "Brown 80%"}, 
                {"label": "Grey 20%", "value": "Grey 20%"}, 
                {"label": "Grey 40%", "value": "Grey 40%"}, 
                {"label": "Grey 60%", "value": "Grey 60%"}, 
                {"label": "Grey 80%", "value": "Grey 80%"}, 
            ]
        }, 
        {
            "name": "chb_photochromic", 
            "label": "Photochromic", 
            "type": "select", 
            "options": [
                {"label": "No", "value": ""}, 
                {"label": "Yes", "value": "1"}, 
            ]
        }, 
        {
            "name": "photochromic_color", 
            "label": "Photochromic Color", 
            "type": "select", 
            "options": [
                {"label": "No Photochromic", "value": ""}, 
                {"label": "Brown", "value": "Brown"}, 
                {"label": "Grey", "value": "Grey"},
            ]
        }, 
        {
            "name": "chb_transition", 
            "label": "Transition", 
            "type": "select", 
            "options": [
                {"label": "No", "value": ""}, 
                {"label": "Yes", "value": "1"}, 
            ]
        }, 
        {
            "name": "transition_color", 
            "label": "Transition Color", 
            "type": "select", 
            "options": [
                {"label": "No Transition", "value": ""}, 
                {"label": "Brown", "value": "Brown"}, 
                {"label": "Grey", "value": "Grey"},
            ]
        }, 
        {
            "name": "anti", 
            "label": "Anti-Reflective", 
            "type": "select", 
            "options": [
                {"label": "No", "value": ""}, 
                {"label": "Yes", "value": "1"}, 
            ]
        }, 
        {"name": "specialRequirement", "label": "Special Requirement", "type":"text"}, 
        {"name": "upload_file", "label": "Upload File", "type":"text"}, 
        {
            "name": "supplier", 
            "label": "Supplier", 
            "type":"select", 
            "options": [
                {"label": "验证未通过", "value": ""}, 
                {"label": "格林视通", "value": "格林视通"}, 
                {"label": "费氏", "value": "费氏"}, 
                {"label": "万新", "value": "万新"}, 
            ]
        }, 
        {"name": "frame", "label": "Frame", "type":"text"}, 
    ], 
};
</script>
<?php
if(!empty($promotions['cart']))
{
    echo '购物车促销：<br>';
    foreach($promotions['cart'] AS $p)
    {
            $psave = '';
        if(isset($p['save']))
        {
            $psave = $p['save'];
        }
        echo '<strong>log</strong>: "' . $p['log'] . '" <strong>save</strong>: $' . $psave;
        echo '<br>';
    }
}
?>
<?php if ($products): ?>
<table>
    <thead>
        <th style="width:20px;">Select</th>
        <th style="width:100px">Image</th>
        <th style="width:50px">Name</th>
<!--        <th style="width:200px">Tracking No.</th>
        <th style="width:200px">Tracking link</th>-->
        <th style="width:230px">Attributes</th>
        <th style="width:80px">SKU</th>
        <th style="width:50px">Original Price</th>
        <th style="width:50px">Price</th>
		<th style="width:50px">Currency Price</th>
        <th style="width:50px">Qty</th>
        <th style="width:50px">Cost</th>
        <th style="width:50px">Weight</th>
        <th style="width:50px">Supplier</th>
        <th style="width:50px">Status</th>
        <th style="width:50px">Is gift</th>
        <th style="width:50px">Remark</th>
        <th style="width:85px">Created</th>
        <th style="width:100px">Action</th>
    </thead>
	<?php
	//获取购买时的国家币种
	//$sys_currencies = kohana::config('currency');
	$currency = DB::query(Database::SELECT, 'select rate,currency FROM orders where id = "'.$id.'"')->execute()->current();
	$sys_currencies = Site::instance()->currencies();
    if(array_key_exists($currency['currency'],$sys_currencies))
    {
        $currencys=$sys_currencies[$currency['currency']];
    }
    else
    {
        $currencys=$sys_currencies['USD'];   
    }
	
	?>
    <?php foreach ($products as $item):
    ?>
    <tr>
        <td>
        <?php
        if($item['status'] != 'cancel')
        {
        ?>
            <input type="checkbox" name="items" class="item_checkbox" value="<?php echo $item['id']; ?>">
        <?php
        }
        ?>
        </td>
        <td><?php print html::image($item['image']); ?></td>
        <td><?php print isset($item['name']) ? (html::anchor($item['link'], $item['name'])) : (html::anchor($item['link'], product::instance($product['id'])->get('name'))); 
//        echo isset($item['attributes'])&&$item['attributes']?("<br/>".str_replace(';',';<br/>', $item['attributes'])):'';
        ?></td>
<!--        <td><?php print $item['tracking_number']; ?></td>
        <td><?php print $item['tracking_link']; ?></td>-->
        <td><strong><?php echo isset($item['attributes'])&&$item['attributes']?("<br/>".str_replace(';',';<br/>', $item['attributes'])):''; ?></strong></td>
        <td><?php print isset($item['sku']) ? $item['sku']:(product::instance($product['id'])->get('sku')); ?><br />
              <?php 
              $sizeandcolor=Product::instance($item['product_id'])->configured_attributes($item['item_id']);
              if(!$item['customize'] && count($sizeandcolor)){
                    echo '('.implode(',', $sizeandcolor).')';
                  }
                  ?>
        </td>
        <!-- 商品卖出时的原价 -->
        <td>
            <?php print $item['original_price']; ?>
        </td>
        <td><?php print $item['price']; ?></td>
		<td><?php echo  $currencys['code'].round($item['price']*$currency['rate'],2);?> </td>
        <td>
            <?php print $item['quantity']; ?>
        </td>
        <td><?php print Product::instance($item['item_id'])->get('cost'); ?></td>
        <td><?php print Product::instance($item['item_id'])->get('weight'); ?></td>
        <td>
            <?php print (isset($item['customize']['supplier']) ? $item['customize']['supplier'] : 'No supplier'); ?>
        </td>
        <td>
            <?php print $item['status']; ?>
        </td>
        <td>
            <?php print $item['is_gift']; ?>
        </td>
        <td>
           <!--  <?php // print $item['erp_line_status']; ?> -->
        </td> 
        <td>
            <?php print date('Y-m-d H:i:s', $item['created']); ?>
        </td>
        <td>
            <?php if ($item['status'] == 'new'): ?>
            <input type="button" value=" Edit " title="Edit item" onclick="item_edit(<?php print $id; ?>, <?php print $item['id']; ?>);"/><br/>
            <input type="button" value=" Cancel " title="Cancle item" onclick="item_cancel(<?php print $id; ?>, <?php print $item['id']; ?>);"/><br/>
            <input type="button" value=" Paste " title="Paste prescription" onclick="item_customize_edit(<?php print $id; ?>, <?php print $item['id']; ?>);" /><br/>
            <?php endif ?>
            <?php if ($item['customize_type'] == 'lens'): ?>
            <div id="d_clip_container_<?php print $item["id"]; ?>" style="position:relative">
            <input type="button" id="d_clip_button_<?php print $item["id"]; ?>" value=" Copy " />
            </div>
            <script type="text/javascript">
            var clip = new ZeroClipboard.Client();
            clip.setText('<?php print serialize($item['customize']); ?>');
            clip.setHandCursor(true);
            clip.addEventListener('onComplete', function(client, text) {
                window.alert('Prescription copied to clipboard!');
            });
            clip.glue('d_clip_button_<?php print $item["id"]; ?>', 'd_clip_container_<?php print $item["id"]; ?>');
            </script>
            <?php endif ?>
        </td>
        <?php if(isset($item['customize']) && $item['customize']){ ?>
            <?php
            if($site_id==4){
                $product = Product::instance($item['product_id']);
                if($product->default_catalog() == '1079'){
            ?>
            <tr>
            <td align="center" valign="middle" colspan="10">
                <table width="100%" border="1" cellpadding="0" cellspacing="0">
                    <tr>
                        <td height="23" colspan="5" align="left" valign="middle" style="border-bottom: 1px solid #000000;">Customize:</td>
                    </tr>
                    <tr>
                        <td height="23" align="left" valign="middle" style="border-bottom: 1px solid #000000;"><strong style="color:red;">Unit:<?php if(isset($item['customize']['unit'])) echo $item['customize']['unit']; ?></strong></td>
                         <td height="23" align="left" valign="middle" style="border-bottom: 1px solid #000000;">color:<?php if(isset($item['customize']['color'])) echo $item['customize']['color']; ?></td>
                         <td height="23" align="left" valign="middle" style="border-bottom: 1px solid #000000;">bust:<?php if(isset($item['customize']['bust'])) echo $item['customize']['bust']; ?></td>
                    </tr>
                    <tr>
                        <td height="23" align="left" valign="middle" style="border-bottom: 1px solid #000000;">arm length : :<?php if(isset($item['customize']['arm-length'])) echo $item['customize']['arm-length']; ?></td>
                        <td height="23" align="left" valign="middle" style="border-bottom: 1px solid #000000;">shoulder :<?php if(isset($item['customize']['shoulder'])) echo $item['customize']['shoulder']; ?></td>
                        <td height="23" align="left" valign="middle" style="border-bottom: 1px solid #000000;">armhole:<?php if(isset($item['customize']['armhole'])) echo $item['customize']['armhole']; ?></td>
                    </tr>
                    <tr>
                          <td height="23" align="left" valign="middle" style="border-bottom: 1px solid #000000;">Special Requirements:</td>
                          <td height="23" align="left" valign="middle" style="border-bottom: 1px solid #000000;" colspan="2"><?php if(isset($item['customize']['special'])) echo $item['customize']['special']; ?></td>
                    </tr>
                </table>
            </td>
        </tr>
            <?php
                    
                } else if($product->default_catalog() == '1036')
            {
            ?>
                    <tr>
            <td align="center" valign="middle" colspan="10">
                <table width="100%" border="1" cellpadding="0" cellspacing="0">
                    <tr>
                        <td height="23" colspan="5" align="left" valign="middle" style="border-bottom: 1px solid #000000;">Customize:</td>
                    </tr>
                    <tr>
                        <td height="23" align="left" valign="middle" style="border-bottom: 1px solid #000000;"><strong style="color:red;">Unit:<?php if(isset($item['customize']['unit'])) echo $item['customize']['unit']; ?></strong></td>
                         <td height="23" align="left" valign="middle" style="border-bottom: 1px solid #000000;">color:<?php if(isset($item['customize']['color'])) echo $item['customize']['color']; ?></td>
                         <td height="23" align="left" valign="middle" style="border-bottom: 1px solid #000000;">bust:<?php if(isset($item['customize']['bust'])) echo $item['customize']['bust']; ?></td>
                    </tr>
                    <tr>
                        <td height="23" align="left" valign="middle" style="border-bottom: 1px solid #000000;">upper bust:<?php if(isset($item['customize']['upper-bust'])) echo $item['customize']['upper-bust']; ?></td>
                        <td height="23" align="left" valign="middle" style="border-bottom: 1px solid #000000;">under bust:<?php if(isset($item['customize']['under-bust'])) echo $item['customize']['under-bust']; ?></td>
                        <td height="23" align="left" valign="middle" style="border-bottom: 1px solid #000000;">around belly :<?php if(isset($item['customize']['around-belly'])) echo $item['customize']['around-belly']; ?></td>
                    </tr>
                    <tr>
                        <td height="23" align="left" valign="middle" style="border-bottom: 1px solid #000000;">hips:<?php if(isset($item['customize']['hips'])) echo $item['customize']['hips']; ?></td>
                        <td height="23" align="left" valign="middle" style="border-bottom: 1px solid #000000;">hollow to floor:<?php if(isset($item['customize']['hollow-to-floor'])) echo $item['customize']['hollow-to-floor']; ?></td>
                        <td height="23" align="left" valign="middle" style="border-bottom: 1px solid #000000;">height:<?php if(isset($item['customize']['height'])) echo $item['customize']['height']; ?></td>
                    </tr>
                    <tr>
                          <td height="23" align="left" valign="middle" style="border-bottom: 1px solid #000000;">Special Requirements:</td>
                          <td height="23" align="left" valign="middle" style="border-bottom: 1px solid #000000;" colspan="2"><?php if(isset($item['customize']['special'])) echo $item['customize']['special']; ?></td>
                    </tr>
                </table>
            </td>
        </tr>
                <?php
                }
                else{
            ?>
        <tr>
            <td align="center" valign="middle" colspan="10">
                <table width="100%" border="1" cellpadding="0" cellspacing="0">
                    <tr>
                        <td height="23" colspan="5" align="left" valign="middle" style="border-bottom: 1px solid #000000;">Customize:</td>
                    </tr>
                    <tr>
                        <td height="23" align="left" valign="middle" style="border-bottom: 1px solid #000000;"><strong style="color:red;">Unit:<?php if(isset($item['customize']['unit'])) echo $item['customize']['unit']; ?></strong></td>
                         <td height="23" align="left" valign="middle" style="border-bottom: 1px solid #000000;">color:<?php if(isset($item['customize']['color'])) echo $item['customize']['color']; ?></td>
                         <td height="23" align="left" valign="middle" style="border-bottom: 1px solid #000000;">bust:<?php if(isset($item['customize']['bust'])) echo $item['customize']['bust']; ?></td>
                    </tr>
                    <tr>
                        <td height="23" align="left" valign="middle" style="border-bottom: 1px solid #000000;">waist:<?php if(isset($item['customize']['waist'])) echo $item['customize']['waist']; ?></td>
                        <td height="23" align="left" valign="middle" style="border-bottom: 1px solid #000000;">hips:<?php if(isset($item['customize']['hips'])) echo $item['customize']['hips']; ?></td>
                        <td height="23" align="left" valign="middle" style="border-bottom: 1px solid #000000;">hollow to floor:<?php if(isset($item['customize']['hollow-to-floor'])) echo $item['customize']['hollow-to-floor']; ?></td>
                    </tr>
                    <tr>
                        <td height="23" align="left" valign="middle" style="border-bottom: 1px solid #000000;">height with shoes:<?php if(isset($item['customize']['height-with-shoes'])) echo $item['customize']['height-with-shoes']; ?></td>
                        <td height="23" align="left" valign="middle" style="border-bottom: 1px solid #000000;">shoulder to floor:<?php if(isset($item['customize']['hips'])) echo $item['customize']['hips']; ?></td>
                        <td height="23" align="left" valign="middle" style="border-bottom: 1px solid #000000;"></td>
                    </tr>
                    <tr>
                          <td height="23" align="left" valign="middle" style="border-bottom: 1px solid #000000;">Special Requirements:</td>
                          <td height="23" align="left" valign="middle" style="border-bottom: 1px solid #000000;" colspan="2"><?php if(isset($item['customize']['special'])) echo $item['customize']['special']; ?></td>
                    </tr>
                </table>
            </td>
        </tr>
        <?php
                }
            }else{
            $lens_index = kohana::config('glasseslens.lens_index');
            $lens = kohana::config('glasseslens.lens');
            $anti = kohana::config('glasseslens.anti');
            ?>
        <tr>
            <td align="center" valign="middle" colspan="10">
                <table width="100%" border="1" cellpadding="0" cellspacing="0">
                    <tr>
                        <td height="23" colspan="5" align="left" valign="middle" style="border-bottom: 1px solid #000000;">Prescription Information</td>
                    </tr>
                    <tr>
                        <td height="23" align="left" valign="middle" style="border-bottom: 1px solid #000000;">Right Eye<br /></td>
                        <td height="23" align="left" valign="middle" style="border-bottom: 1px solid #000000;">SPH:<?php if(isset($item['customize']['od_sph'])) echo $item['customize']['od_sph']; ?></td>
                        <td height="23" align="left" valign="middle" style="border-bottom: 1px solid #000000;">CYL:<?php if(isset($item['customize']['od_cyl'])) echo $item['customize']['od_cyl']; ?> </td>
                        <td height="23" align="left" valign="middle" style="border-bottom: 1px solid #000000;">Axis:<?php if(isset($item['customize']['od_axis'])) echo $item['customize']['od_axis']; ?> </td>
                        <td height="23" align="left" valign="middle" style="border-bottom: 1px solid #000000;">ADD:<?php if(isset($item['customize']['od_add'])) echo $item['customize']['od_add']; ?></td>
                    </tr>
                    <tr>
                        <td height="23" align="left" valign="middle" style="border-bottom: 1px solid #000000;">Left Eye</td>
                        <td height="23" align="left" valign="middle" style="border-bottom: 1px solid #000000;">SPH:<?php if(isset($item['customize']['os_sph'])) echo $item['customize']['os_sph']; ?> </td>
                        <td height="23" align="left" valign="middle" style="border-bottom: 1px solid #000000;">CYL:<?php if(isset($item['customize']['os_cyl'])) echo $item['customize']['os_cyl']; ?> </td>
                        <td height="23" align="left" valign="middle" style="border-bottom: 1px solid #000000;">Axis:<?php if(isset($item['customize']['os_axis'])) echo $item['customize']['os_axis']; ?> </td>
                        <td height="23" align="left" valign="middle" style="border-bottom: 1px solid #000000;">ADD:<?php if(isset($item['customize']['os_add'])) echo $item['customize']['os_add']; ?></td>
                    </tr>
                    <tr>
                        <td height="23" align="left" valign="middle" style="border-bottom: 1px solid #000000;">PD</td>
                        <td height="23" align="left" valign="middle" style="border-bottom: 1px solid #000000;">PD:<?php if(isset($item['customize']['pd_far'])) echo $item['customize']['pd_far']; ?> </td>
                        <td height="23" align="left" valign="middle" style="border-bottom: 1px solid #000000;">MONO R:<?php if(isset($item['customize']['pd_r'])) echo $item['customize']['pd_r']; ?> </td>
                        <td height="23" align="left" valign="middle" style="border-bottom: 1px solid #000000;">MONO L:<?php if(isset($item['customize']['pd_l'])) echo $item['customize']['pd_l']; ?> </td>
                        <td height="23" align="left" valign="middle" style="border-bottom: 1px solid #000000;">Near PD:<?php if(isset($item['customize']['pd_near'])) echo $item['customize']['pd_near']; ?></td>
                    </tr>
                </table>
            </td>
        </tr>
        <?php
        $total = 0;
        $lens_price = $lens[$item['customize']['lensType']]['price'];
        $index_price = $lens_index[$item['customize']['lens_index']]['price'];
        $total = floatval($lens_price) + floatval($index_price);

        if(isset($item['customize']['extra']) && $item['customize']['extra'] =='1')
        {
            $total +=8;
        }
        if(isset($item['customize']['anti']) && $item['customize']['anti'] !='')
        {
            $total +=4.95;
        }
        if(isset($item['customize']['color_tint']) && $item['customize']['color_tint'] !='')
        {
            $total +=4.95;
        }
        if(isset($item['customize']['photochromic_color']) && $item['customize']['photochromic_color'] !='')
        {
            $total +=34.95;
        }
        if(isset($item['customize']['transition_color']) && $item['customize']['transition_color'] !='')
        {
            $total +=199.95;
        }
        if($total)
        {
            $total ='$'.$total;
        }
        else
        {
            $total ='$0.00';
        }
        ?>
        <tr>
            <td align="center" valign="middle" colspan="10">
                <table width="100%" border="1" cellpadding="0" cellspacing="0">
                    <tr>
                        <td height="23" colspan="5" align="left" valign="middle" style="border-bottom: 1px solid #000000;">Lens Information</td>
                    </tr>
                    <tr>
                        <td height="23" align="left" valign="middle" style="border-bottom: 1px solid #000000;">Lens Type<br /></td>
                        <td height="23" colspan="2" align="left" valign="middle" style="border-bottom: 1px solid #000000;"><?php if(isset($item['customize']['lensType'])) echo $lens[$item['customize']['lensType']]['name']; ?></td>
                        <td height="23" align="left" valign="middle" style="border-bottom: 1px solid #000000;">Lens Price</td>
                        <td height="23" id="lens_price"  align="left" valign="middle" style="border-bottom: 1px solid #000000;"><?php if(isset($item['customize']['lensType'])) echo "$".$lens[$item['customize']['lensType']]['price']; ?></td>
                    </tr>
                    <tr>
                        <td height="23" align="left" valign="middle" style="border-bottom: 1px solid #000000;">Index</td>
                        <td height="23" colspan="2" align="left" valign="middle" style="border-bottom: 1px solid #000000;"><?php if(isset($item['customize']['lens_index'])) echo $lens_index[$item['customize']['lens_index']]['name']; ?><?php if(isset($item['customize']['lens_index_color'])) echo ','.$item['customize']['lens_index_color']; ?></td>
                        <td height="23" align="left" valign="middle" style="border-bottom: 1px solid #000000;">Index Price</td>
                        <td height="23" id="index_price" align="left" valign="middle" style="border-bottom: 1px solid #000000;"><?php if(isset($item['customize']['lens_index'])) echo "$".$lens_index[$item['customize']['lens_index']]['price']; ?></td>
                    </tr>
                    <tr>
                        <td height="23" align="left" valign="middle" style="border-bottom: 1px solid #000000;">Special Add-On</td>
                        <td height="23" colspan="2" align="left" valign="middle" style="border-bottom: 1px solid #000000;"><?php if(isset($item['customize']['chb_color_tint']) && isset($item['customize']['color_tint'])) echo ' Color Tint , '.$item['customize']['color_tint']; ?>
                            <?php if(isset($item['customize']['chb_photochromic']) && isset($item['customize']['photochromic_color'])) echo ' Mid-index 1.553 thin Photochromic , '.$item['customize']['photochromic_color']; ?>
                            <?php if(isset($item['customize']['chb_transition']) && isset($item['customize']['transition_color'])) echo ' Transitions® VI Lenses , '.$item['customize']['transition_color']; ?></td>
                        <td height="23" align="left" valign="middle" style="border-bottom: 1px solid #000000;">Special Price</td>
                        <td height="23" id="special_price" align="left" valign="middle" style="border-bottom: 1px solid #000000;"><?php if(isset($item['customize']['color_tint']) && $item['customize']['color_tint'] !='') echo '$4.95'; ?>
                            <?php if(isset($item['customize']['chb_photochromic']) && isset($item['customize']['photochromic_color']) && $item['customize']['photochromic_color'] !='') echo '$34.95'; ?>
                            <?php if(isset($item['customize']['chb_transition']) && isset($item['customize']['transition_color']) && $item['customize']['transition_color'] !='') echo '$199.95'; ?>
                        </td>
                    </tr>
                    <tr>
                        <td height="23" align="left" valign="middle" style="border-bottom: 1px solid #000000;">Anti</td>
                        <td height="23" colspan="2" align="left" valign="middle" style="border-bottom: 1px solid #000000;"><?php if(isset($item['customize']['anti']) && $item['customize']['anti'] !='') echo $anti['name']; ?></td>
                        <td height="23" align="left" valign="middle" style="border-bottom: 1px solid #000000;">Anti Price</td>
                        <td height="23" id="anti_price" align="left" valign="middle" style="border-bottom: 1px solid #000000;"><?php if(isset($item['customize']['anti']) && $item['customize']['anti'] !='') echo "$".$anti['price'];?></td>
                    </tr>
                    <tr>
                        <td height="23" align="left" valign="middle" style="border-bottom: 1px solid #000000;">Extra Price</td>
                        <td height="23" colspan="4" align="left" valign="middle" style="border-bottom: 1px solid #000000;"><?php if(isset($item['customize']['extra']) && $item['customize']['extra'] =='1') echo '$8.00';?></td>
                    </tr>
                    <tr>
                        <td height="23" align="left" valign="middle" style="border-bottom: 1px solid #000000;">Special requirements</td>
                        <td height="23" colspan="4" align="left" valign="middle" style="border-bottom: 1px solid #000000;"><?php if(isset($item['customize']['specialRequirement'])) echo $item['customize']['specialRequirement']; ?></td>
                    </tr>
                    <tr>
                        <td height="23" align="left" valign="middle" style="border-bottom: 1px solid #000000;">Customized Lens</td>
                        <td height="23" colspan="4" align="left" valign="middle" style="border-bottom: 1px solid #000000;"></td>
                    </tr>
                    <tr>
                        <td height="23" align="left" valign="middle" style="border-bottom: 1px solid #000000;">Upload</td>
                        <td height="23" colspan="4" align="left" valign="middle" style="border-bottom: 1px solid #000000;"><?php if(isset($item['customize']['upload_file']) && $item['customize']['upload_file']!=0 ){ ?><input type="button" value="download" onclick="download(<?php echo $item['customize']['upload_file']; ?>)"><?php } ?></td>
                    </tr>
                    <script type="text/javascript">
                        function download(id)
                        {
                            $.post('/admin/site/order/lens_downlad',
                            {
                                id:id
                            },
                            function(data)
                            {
                                if(data)
                                {
                                    window.open('http://www.ezclickoptical.com/data/upload/'+data, '_blank');
                                }
                                else
                                {
                                    return false;
                                }
                            }
                        );
                        }
                    </script>
                    <tr>
                        <td height="23" align="left" valign="middle" style="border-bottom: 1px solid #000000;">Shipping Fee</td>
                        <td height="23" colspan="4" align="left" valign="middle" style="border-bottom: 1px solid #000000;"></td>
                    </tr>
                    <tr>
                        <td height="23" align="left" valign="middle" style="border-bottom: 1px solid #000000;">Coupon Code</td>
                        <td height="23" colspan="2" align="left" valign="middle" style="border-bottom: 1px solid #000000;"></td>
                        <td height="23" align="left" valign="middle" style="border-bottom: 1px solid #000000;">Discount</td>
                        <td height="23" align="left" valign="middle" style="border-bottom: 1px solid #000000;"></td>
                    </tr>
                    <tr>
                        <td height="23" align="left" valign="middle" style="border-bottom: 1px solid #000000;">Total</td>
                        <td height="23" id="total_price" colspan="2" align="left" valign="middle" style="border-bottom: 1px solid #000000;"><?php echo $total; ?></td>
                        <td height="23" align="left" valign="middle" style="border-bottom: 1px solid #000000;"></td>
                        <td height="23" align="left" valign="middle" style="border-bottom: 1px solid #000000;"></td>
                    </tr>
                </table>
            </td>
        </tr>
        <?php }} ?>
    </tr>

    <?php endforeach ?>
</table>
<?php endif ?>



<script>
    $(function(){
        $(".item_checkbox").click(function(){
            var id = $(this).val();
            if($(this).attr('checked'))
            {
                var itemspost = $("#itemsPost").val();
                itemspost = itemspost + ',' + id;
                $("#itemsPost").val(itemspost);
            }
            else
            {
                var itemspost = $("#itemsPost").val();
                var removeid = ',' + id;
                itemspost = itemspost.replace(removeid, '');
                $("#itemsPost").val(itemspost);
            }
        })

        $("#daysss").change(function(){
             var daysss = $("#daysss").val();
            
        })

        $("#itemsForm").submit(function(){
            var order_id = $("#itemsOrderid").val();
            var items = $("#itemsPost").val();
            $.post(
                '/admin/site/email/order_item_outstock',
                {
                    order_id: order_id,
                    items: items
                },
                function(data)
                {
                    if(data.success)
                    {
                        alert('Set item out of stock success!');
                        window.location.reload();
                    }
                    else
                    {
                        window.alert(data.message);
                    }
                },
                'json'
            );
            return false;
        })

        $("#baodengForm").submit(function(){
            var order_id = $("#itemsOrderid").val();
            var items = $("#itemsPost").val();
            var days = $("#daysss").val();
            $.post(
                '/admin/site/order/baodeng',
                {
                    order_id: order_id,
                    items: items,
                    days: days
                },
                function(data)
                {
                    if(data.success)
                    {
                        alert('success!');
                       // window.location.reload();
                    }
                    else
                    {
                        window.alert(data.message);
                    }
                },
                'json'
            );
            return false;
        })
    })
</script>

<?php
if(!empty($products))
{
?>
<form method="post" action="/admin/site/email/order_item_outstock" id="itemsForm">
    <input type="hidden" name="order_id" value="<?php echo $products[0]['order_id']; ?>" id="itemsOrderid">
    <input type="hidden" name="items" value="" id="itemsPost">
    <input type="submit" value="产品缺货">
</form>
<br>
<form method="post" action="/admin/site/order/baodeng" id="baodengForm">
    <input type="hidden" name="order_id" value="<?php echo $products[0]['order_id']; ?>" id="itemsOrderid">
    预计到货天数:<input type="text" name="days" id="daysss" />
    <input type="submit" value="通知报等">
</form>
<?php
}
?>

<button id="btn-add-product">Add Product</button>

<style type="text/css">
    fieldset label, fieldset input {display:block;}
    fieldset input.text {width:240px}
    fieldset label, legend {font-weight: bold}
</style>

<div id="dialog-add-product" title="Add product to this order">
    <form id="frm-add-product">
        <input type="hidden" id="add-order_id" name="order_id" value="<?php echo $id; ?>" />
        <fieldset id="add-basic">
            <legend>Basic</legend>
            <label for="add-sku">SKU</label>
            <input type="text" name="sku" id="add-sku" class="text ui-widget-content ui-corner-all" />
            <label for="add-quantity">Quantity(退货单请填负值)</label>
            <input type="text" name="quantity" id="add-quantity" class="text ui-widget-content ui-corner-all" />
            <label for="add-price">Price</label>
            <input type="text" name="price" id="add-price" class="text ui-widget-content ui-corner-all" />
        </fieldset>
    </form>
</div>
<script>
$(function(){
        $("#add-sku").live('change', function(){
                var sku = $(this).val();
                $.post(
                '/admin/site/order/product_attributes',
                {
                        sku: sku
                },
                function(attributes)
                {
                        if(attributes)
                        {
                                $("#attributes").html(attributes);
                        }
                },
                'json'
        );
        })
        
        $("#add-customize_type_attributes").live('click', function(){
                var sku = $("#add-sku").val();
                $.post(
                '/admin/site/order/product_attributes',
                {
                        sku: sku
                },
                function(attributes)
                {
                        if(attributes)
                        {
                                $("#attributes").html(attributes);
                        }
                },
                'json'
        );
        })
})
</script>

<div id="dialog-edit-product" title="Edit product">
    <form id="frm-edit-product">
        <input type="hidden" id="edit-order_id" name="order_id" />
        <input type="hidden" id="edit-item_id" name="item_id" />
        <fieldset id="edit-basic">
            <legend>Basic</legend>
            <label for="edit-quantity">Qty(退货单请填负值)</label>
            <input type="text" name="quantity" id="edit-quantity" class="text ui-widget-content ui-corner-all"/>
            <label for="edit-price">Price</label>
            <input type="text" name="price" id="edit-price" class="text ui-widget-content ui-corner-all" />
        </fieldset>
    </form>
</div>

<div id="dialog-update-customize" title="Update Customize">
    <form id="frm-update-customize">
        <input type="hidden" id="update-order_id" name="order_id"/>
        <input type="hidden" id="update-item_id" name="item_id"/>
        <input type="hidden" id="update-customize_type" name="customize_type" value="lens" />
        <textarea id="update-customize" name="customize" style="width:100%;height:240px"></textarea>
    </form>
</div>
<br><br>
<div>
<?php 
$order_status = array_merge(kohana::config('order_status.payment'), kohana::config('order_status.shipment'), kohana::config('order_status.refund'));
?>
<?php if($histories): ?>

<table>
    <tr>
        <thead>
            <th class="col">动作</th>
            <th class="col">管理员ID</th>
            <th class="col">备注</th>
            <th class="col">时间</th>
        </thead>
    </tr>
    <?php foreach($histories as $history): ?>
        <?php
            if(strpos($history['message'],"报缺")===false && strpos($history['message'],"报等")===false)
            {
        ?>
                
        <?php
            }else
            {
        ?>
            <tr>
                <td><?php print $history['order_status']; ?></td>
                <td><?php print User::instance($history['admin_id'])->get('name');?></td> 
                <td><?php print $history['message'];?></td>
                <td><?php print date('Y-m-d H:i:s', $history['created']);?></td>
            </tr>
        <?php
            }
        ?>

    <?php endforeach ?>
</table>
<?php else: ?>
<strong>无产品操作记录</strong>
<?php endif ?>
</div>

<script type="text/javascript">
function make_field(field_desc, field_value)
{
    var field = '<label>'+field_desc.label+'</label>';
    switch (field_desc.type) {
        case 'select':
            field += '<select name="customize['+field_desc.name+']" style="width:250px;margin:10px 0">';
            for (var i=0; i<field_desc.options.length; i++) {
                var option = field_desc.options[i];
                field += '<option value="'+option.value+'"';

                if (field_value == option.value) 
                    field += ' selected="selected"';

                field += '>'+option.label+'</option>';
            }

            field += '</select><br/>';
            break;
        case 'text':
        default:
            field += '<input type="text" name="customize['+field_desc.name+']"';
            if (field_value)
                field += ' value="'+field_value+'"';

            field += ' class="text ui-wdiget-content ui-corner-all" /><br/>';
            break;
    }

    return field;
}

function item_delete(id, item_id, product) {
    if (window.confirm('确定要删除这个产品？')) {
        $.post('/admin/site/order/item_delete/'+id, {'item_id': item_id}, function (data) {
            if (data == 'success') {
                product.remove();
            } else {
                window.alert(data);
            }
        });
    }
}

function item_cancel(id, item_id) {
    if (window.confirm('确定要取消该订单行？')) {
        $.post('/admin/site/order/item_cancel/'+id, {'item_id': item_id}, function (data) {
            if (data == 'success') {
                window.location.reload(true);
            } else {
                window.alert(data);
            }
        });
    }
}

function item_edit(id, item_id)
{
    $('#edit-order_id').attr('value', id);
    $('#edit-item_id').attr('value', item_id);
    $.ajax({
        "url": "/admin/site/order/item_data/"+id, 
        "type": "POST", 
        "dataType": "json", 
        "data": "item_id="+item_id, 
        "success": function (data) {
            $('#edit-quantity').val(data['quantity']);
            $('#edit-price').val(data['price']);
            $('#edit-customize_type_' + data['customize_type']).attr('checked', true);
            if (data['customize_type'] != 'lens') {
                var customizes = customize_types[data['customize_type']];
                $('#frm-edit-product').append('<fieldset id="edit-customize"><legend>Customize</legend></fieldset>');
                var fieldset_customize = $('#edit-customize');
                for (var i=0; i<customizes.length; i++) {
                    fieldset_customize.append(make_field(customizes[i], data['customize'][customizes[i]['name']]));
                }
            }
            if(data['attributes'] != null&&data['attributes'] != '')
            {
            	$("#frm-edit-product input[name='customize_type']").each(function(){
					$(this).attr("disabled","disabled");
                	})
                 $('#frm-edit-product').append('<fieldset id="edit-customize"><legend>Customize</legend></fieldset>');
                 var fieldset_customize = $('#edit-customize');
                 var field = '<label>Attributes</label>';
                 field += '<input type="text" name="attributes" value="'+data['attributes']+'" class="text ui-wdiget-content ui-corner-all" /><br/>';
                 fieldset_customize.append(field);
            }
            $('#dialog-edit-product').dialog('open');
        }
    });
}

function item_customize_edit(id, item_id)
{
    $('#update-order_id').attr('value', id);
    $('#update-item_id').attr('value', item_id);
    $('#dialog-update-customize').dialog('open');
}

$('#btn-add-product')
    .button()
    .click(function() {
        $('#dialog-add-product').dialog('open')
    });

// dialog initialize
$('#dialog-add-product').dialog({
    autoOpen: false,
    width:320, 
    height:420, 
    modal: true, 
    buttons: {
        "Add": function () {
            $.ajax({
                "url": "/admin/site/order/item_add/", 
                "type": "POST", 
                "data": $('#frm-add-product').serialize(), 
                "success": function (data) {
                    if (data == 'success') {
                        $('#dialog-add-product').dialog('close')
                        window.location.reload(true);
                    } else {
                        window.alert(data);
                    }
                }
            });
        }, 
        "Cancel": function () {
            $('#add-customize').remove();
            $('#dialog-add-product').dialog('close')
        }
    }, 
    close: function() {
            $('#edit-customize').remove();
    }
});

$('#dialog-edit-product').dialog({
    autoOpen: false, 
    modal: true, 
    width: 320, 
    height: 420, 
    buttons: {
        "Save": function() {
            $.ajax({
                "url": "/admin/site/order/item_edit", 
                "type": "POST", 
                "data": $('#frm-edit-product').serialize(), 
                "success": function(data) {
                    if (data == 'success') {
                        $('#dialog-edit-product').dialog('close');
                        $('#edit-customize').remove();
                        window.location.reload(true);
                    } else {
                        window.alert(data);
                    }
                } 
            });
        }, 
        "Cancel": function() {
            $('#edit-customize').remove();
            $(this).dialog('close');
        }
    }, 
    close: function() {
            $('#edit-customize').remove();
    }
});

$('#dialog-update-customize').dialog({
    autoOpen: false, 
    modal: true, 
    width:480, 
    height: 320, 
    buttons: {
        "Save": function() {
            $.ajax({
                url: "/admin/site/order/item_customize", 
                type: "POST", 
                data: $('#frm-update-customize').serialize(), 
                success: function(data) {
                    if (data == 'success') {
                        $('dialog-update-customize').dialog('close');
                        window.location.reload(true);
                    } else {
                        window.alert(data);
                    }
                }
            });
        }
    }
});

var frm_add = $('#frm-add-product');
//for (var key in customize_types) {
//    frm_add.append('<input type="radio" id="add-customize_type_'+key+'" name="customize_type" value="'+key+'" /><label for="add-customize_type_'+key+'">'+key+'</label> ');
//    var radio = $('#add-customize_type_'+key);
//    if (key == 'none')
//        radio.attr('checked', true);
//    radio.change(function (event) {
//        var r = $(event.target);
//        if (r.attr('checked')) {
//            $('#add-customize').remove();
//            var customizes = customize_types[r.val()];
//            if (customizes.length > 0) {
//                $('#frm-add-product').append('<fieldset id="add-customize"><legend>Customize</legend></fieldset>');
//                var fieldset_customize = $('#add-customize');
//                for (var i=0; i<customizes.length; i++) {
//                    var customize = customizes[i];
//                    fieldset_customize.append(make_field(customize, null));
//                }
//            }
//        }
//    });
//}
//frm_add.append('<input type="radio" id="add-customize_type_attributes" name="customize_type" value="attributes" /><label for="add-customize_type_attributes">attributes</label> ');
//$("#add-customize_type_attributes").click(function(){
//	$('#add-customize').remove();
//	frm_add.append('<fieldset id="add-customize"><legend>Customize</legend></fieldset>');
//	 var fieldset_customize = $('#add-customize');
//	 var field = '<label>Attributes</label>';
//     field += '<div id="attributes"><input type="text" name="attributes" class="text ui-wdiget-content ui-corner-all" /></div><br/>';
//     fieldset_customize.append(field);
//});

$('#add-customize').remove();
	frm_add.append('<fieldset id="add-customize"><legend>Attributes</legend></fieldset>');
        var fieldset_customize = $('#add-customize');
        var field = '';
        field += '<div id="attributes"><input type="text" name="attributes" class="text ui-wdiget-content ui-corner-all" /></div><br/>';
        fieldset_customize.append(field);

var frm_edit = $('#frm-edit-product');
for (var key in customize_types) {
    frm_edit.append('<input type="radio" id="edit-customize_type_'+key+'" name="customize_type" value="'+key+'" /><label for="edit-customize_type_'+key+'">'+key+'</label> ');
    var radio = $('#edit-customize_type_'+key);
    radio.change(function (event) {
        var r = $(event.target);
        if (r.attr('checked')) {
            $('#edit-customize').remove();
            var customizes = customize_types[r.val()];
            if (customizes.length > 0) {
                $('#frm-edit-product').append('<fieldset id="edit-customize"><legend>Customize</legend></fieldset>');
                var fieldset_customize = $('#edit-customize');
                for (var i=0; i<customizes.length; i++) {
                    var customize = customizes[i];
                    fieldset_customize.append(make_field(customize, null));
                }
            }
        }
    });
}
</script>
<script type="text/javascript">
// prepare the form when the DOM is ready 
$(document).ready(function() { 

  // Setup the ajax indicator
  $('body').append('<div id="ajaxBusy"><p><img src="/media/images/loading.gif"></p></div>');

  $('#ajaxBusy').css({
    display:"none",
    margin:"0px",
    paddingLeft:"0px",
    paddingRight:"0px",
    paddingTop:"0px",
    paddingBottom:"0px",
    position:"absolute",
    width:"auto", 
    zIndex: "100000", 
  });

  $('#ajaxBusy').center({
      against: 'window'
  });
});

// Ajax activity indicator bound to ajax start/stop document events
$(document).ajaxStart(function(){ 
  $('#ajaxBusy').show(); 
}).ajaxStop(function(){ 
  $('#ajaxBusy').hide();
});
</script>
